# План сквозного тестирования Conspektor (MVP)

## Введение

Данный документ описывает сценарии сквозного (end-to-end) тестирования MVP системы «Conspektor» — распределенной системы для совместного редактирования документов.

**Охват MVP**:
- Создание, просмотр и редактирование документов
- Совместная работа в реальном времени через WebSocket
- Управление сессиями и подключениями

**Предусловия для всех тестов**:
- Система развернута через docker-compose
- API Gateway доступен по `http://localhost:8000`
- Frontend доступен по `http://localhost:8080`
- В системе созданы минимум 2 тестовых пользователя

---

## 1. Тестирование управления документами

### Тест 1.1: Создание нового документа через API

**Цель**: проверить создание документа через Document Service

**Предусловия**:
- Существует пользователь с username `user(1)`
- Пользователь авторизован

**Шаги**:
1. Отправить HTTP-запрос:
   ```
   POST http://localhost:8000/documents
   Headers:
     Content-Type: application/json
     Authorization: Bearer <valid-token>
   Body:
   {
     "title": "Тестовый документ",
     "content": "Начальный контент"
   }
   ```

**Ожидаемый результат**:
- HTTP статус: 200 OK
- Тело ответа содержит созданный документ:
  ```json
  {
    "id": "<uuid>",
    "title": "Тестовый документ",
    "content": "Начальный контент",
    "created_at": "<timestamp>",
    "updated_at": "<timestamp>"
  }
  ```
- Документ сохраняется в БД PostgreSQL
- Документ доступен для последующего получения

### Тест 1.2: Получение документа через API

**Цель**: проверить получение документа из Document Service

**Предусловия**:
- Документ с ID `77777777-7777-7777-7777-777777777777` существует в БД

**Шаги**:
1. Отправить запрос на получение документа:
   ```
   GET http://localhost:8000/documents/77777777-7777-7777-7777-777777777777
   ```

**Ожидаемый результат**:
- HTTP статус: 200 OK
- Тело ответа содержит полные данные документа
- Поля документа соответствуют сохраненным в БД
- Время ответа находится в допустимых пределах (<500ms)

### Тест 1.3: Обновление документа

**Цель**: проверить обновление документа через Document Service

**Предусловия**:
- Документ с ID `77777777-7777-7777-7777-777777777777` существует
- Известен текущий контент документа

**Шаги**:
1. Отправить запрос на обновление:
   ```
   PUT http://localhost:8000/documents/77777777-7777-7777-7777-777777777777
   Headers:
     Content-Type: application/json
   Body:
   {
     "title": "Обновленный заголовок",
     "content": "Новый контент"
   }
   ```
2. Получить обновленный документ:
   ```
   GET http://localhost:8000/documents/77777777-7777-7777-7777-777777777777
   ```

**Ожидаемый результат**:
- PUT запрос возвращает обновленный документ
- Поля `title` и `content` соответствуют отправленным значениям
- Поле `updated_at` обновляется
- GET запрос возвращает актуальные данные

### Тест 1.4: Получение документов пользователя

**Цель**: проверить получение списка документов пользователя

**Предусловия**:
- Пользователь с username `user(1)` существует
- У пользователя есть 3 документа

**Шаги**:
1. Получить пользователя по username:
   ```
   GET http://localhost:8000/users/username/user(1)
   ```
2. Получить документы пользователя:
   ```
   GET http://localhost:8000/documents/user/{user(id)}
   ```

**Ожидаемый результат**:
- Первый запрос возвращает данные пользователя с ID
- Второй запрос возвращает массив из 3 документов
- Каждый документ содержит правильные поля
- Документы отсортированы по `updated_at` DESC

---

## 2. Тестирование совместного редактирования (WebSocket)

### Тест 2.1: Подключение к документу через WebSocket

**Цель**: проверить подключение к Collaboration Hub и управление подключениями

**Предусловия**:
- Документ с ID `doc-ws-001` существует
- Пользователь имеет доступ к документу

**Шаги**:
1. Установить WebSocket соединение:
   ```
   WS ws://localhost:8000/ws/documents/doc-ws-001?token=valid-token
   ```
2. Проверить информацию о подключениях
3. Дождаться ответа от сервера

**Ожидаемый результат**:
- Соединение успешно устанавливается
- Сервер отправляет сообщение типа `initial` с текущим контентом
- Информация о подключении корректно обрабатывается
- Пользователь добавляется в комнату документа

### Тест 2.2: Совместное редактирование документа двумя пользователями

**Цель**: проверить синхронизацию изменений между пользователями

**Предусловия**:
- Два пользователя: UserA и UserB
- Документ существует
- Оба пользователя имеют доступ

**Шаги**:
1. UserA подключается по WebSocket к документу
2. UserB подключается по WebSocket к тому же документу
3. Проверить состояние подключений
4. UserA отправляет изменение:
   ```json
   {
     "type": "change",
     "content": "Новый текст от UserA"
   }
   ```
5. UserB отправляет изменение:
   ```json
   {
     "type": "change",
     "content": "Новый текст от UserA и UserB"
   }
   ```

**Ожидаемый результат**:
- UserA получает обновление от UserB
- UserB получает обновление от UserA
- Оба пользователя видят одинаковый конечный контент
- Состояние синхронизировано в реальном времени
- Управление сессиями работает корректно

---

## 3. Тестирование UI через Frontend

### Тест 3.1: Просмотр списка документов в UI

**Цель**: проверить отображение документов во фронтенде

**Предусловия**:
- Пользователь авторизован в системе
- У пользователя есть минимум 2 документа

**Шаги**:
1. Открыть в браузере: `http://localhost:8080/account`
2. Дождаться загрузки страницы
3. Проверить отображение списка документов

**Ожидаемый результат**:
- Страница успешно загружается
- Отображается список документов пользователя
- Для каждого документа отображается заголовок
- Документы отсортированы по дате изменения (свежие сверху)

### Тест 3.2: Создание документа через UI

**Цель**: проверить создание документа через интерфейс

**Предусловия**:
- Пользователь авторизован
- Пользователь находится на странице списка документов

**Шаги**:
1. Нажать кнопку "создать"
2. Ввести заголовок: "Мой новый документ"
3. Нажать "ОК"

**Ожидаемый результат**:
- Документ создается
- Новый документ появляется в списке документов
- Заголовок соответствует введенному

### Тест 3.3: Редактирование документа в реальном времени

**Цель**: проверить работу редактора с WebSocket

**Предусловия**:
- Документ открыт в редакторе
- WebSocket соединение установлено

**Шаги**:
1. Ввести текст в редакторе: "Привет, мир!"
2. Подождать 1 секунду
3. Открыть тот же документ в другом окне браузера
4. Проверить состояние подключения

**Ожидаемый результат**:
- Текст в первом окне отображается корректно
- Во втором окне сразу отображается текст "Привет, мир!"
- При изменении в одном окне, изменения видны в другом
- Управление сессиями работает корректно

---

## 4. Тестирование интеграции компонентов

### Тест 4.1: Сквозной поток создания и редактирования

**Цель**: проверить полный цикл работы с документом

**Предусловия**:
- Пользователь авторизован

**Шаги**:
1. Через UI создать документ с заголовком "Интеграционный тест"
2. Через API получить список документов пользователя
3. Найти созданный документ по заголовку
4. Получить документ по ID через API
5. Обновить документ через API:
   ```
   PUT /documents/{id}
   Body: {"content": "Обновленный через API"}
   ```
6. Открыть документ в UI
7. Проверить отображение обновленного контента
8. Отредактировать документ в UI
9. Проверить обновление через API
10. Проверить состояние сессий

**Ожидаемый результат**:
- Все операции выполняются успешно
- Данные консистентны между UI и API
- Изменения сохраняются корректно
- WebSocket синхронизация работает
- Управление подключениями функционирует

### Тест 4.2: Масштабирование Collaboration Hub

**Цель**: проверить работу при множественных подключениях

**Предусловия**:
- Запущено несколько экземпляров Collaboration Hub

**Шаги**:
1. Подключить пользователей к одному документу через разные инстансы Hub
2. Провести совместное редактирование
3. Проверить синхронизацию между всеми пользователями
4. Проверить состояние подключений

**Ожидаемый результат**:
- Все пользователи видят одинаковый контент
- Изменения синхронизируются между всеми инстансами
- Управление сессиями функционирует в распределенном режиме

--- 

## 5. Тестирование обработки ошибок

### Тест 5.1: Доступ к несуществующему документу

**Цель**: проверить обработку 404 ошибки

**Шаги**:
1. Отправить запрос к несуществующему документу:
   ```
   GET http://localhost:8000/documents/non-existent-id
   ```
2. Попытаться подключиться по WebSocket:
   ```
   WS ws://localhost:8000/ws/documents/non-existent-id?token=valid
   ```

**Ожидаемый результат**:
- GET запрос возвращает HTTP 404
- WebSocket соединение закрывается с ошибкой "Document not found"
- В логах Collaboration Hub есть соответствующая запись

### Тест 5.2: Конкурентное редактирование с конфликтами

**Цель**: проверить обработку одновременных изменений

**Предусловия**:
- Два пользователя подключены к одному документу
- Начальный контент: "Начало"

**Шаги**:
1. UserA меняет контент на "Версия A"
2. Одновременно (в течение 100ms) UserB меняет контент на "Версия B"
3. Подождать 3 секунды
4. Проверить конечное состояние у обоих пользователей
5. Проверить состояние сессий

**Ожидаемый результат**:
- Оба пользователя видят одинаковый конечный контент
- Контент соответствует одному из изменений (последнему принятому)
- Нет потери данных
- Collaboration Hub обрабатывает конфликт корректно
- Сессии остаются стабильными

---

## 6. Тестирование производительности и масштабирования

### Тест 6.1: Множественные подключения к одному документу

**Цель**: проверить работу с несколькими участниками

**Предусловия**:
- Документ существует
- Подготовлено 5 тестовых пользователей

**Шаги**:
1. Подключить всех 5 пользователей к одному документу
2. Проверить состояние подключений
3. Каждый пользователь отправляет по 3 изменения
4. Замерить время отклика для каждого пользователя
5. Проверить конечное состояние документа
6. Проверить нагрузку на управление сессиями

**Ожидаемый результат**:
- Все пользователи успешно подключаются
- Изменения доставляются всем участникам
- Время отклика < 500ms для каждого сообщения
- Конечное состояние одинаковое у всех пользователей
- Управление подключениями работает эффективно
- Потребление ресурсов остается в допустимых пределах

### Тест 6.2: Нагрузочное тестирование Document Service

**Цель**: проверить производительность Document Service под нагрузкой

**Предусловия**:
- В системе создано 50 документов
- Настроен мониторинг запросов к БД

**Шаги**:
1. Запустить 10 параллельных запросов на получение документов
2. Замерить общее время выполнения
3. Проверить количество успешных запросов
4. Проверить время отклика 95-го перцентиля
5. Мониторить ошибки и таймауты

**Ожидаемый результат**:
- Успешность запросов > 95%
- Время отклика 95-го перцентиля < 1s
- БД справляется с нагрузкой
- Нет утечек соединений или памяти

---

## 7. Комплексные сценарии

### Тест 7.1: Полный жизненный цикл документа

**Цель**: проверить полный сценарий работы с документом

**Предусловия**:
- Существует пользователь "author"
- Существует пользователь "collaborator"

**Шаги**:
1. Авторизоваться под пользователем "author"
2. Создать документ через UI: "Проект Alpha"
3. Добавить контент: "Цели проекта..."
4. Поделиться документом с пользователем "collaborator"
5. "Collaborator" открывает документ
6. Оба редактируют документ одновременно
7. Проверить синхронизацию изменений
8. Сохранить финальную версию
9. Проверить данные через API
10. Проверить состояние сессий и подключений

**Ожидаемый результат**:
- Все этапы выполняются успешно
- Соавторы видят изменения в реальном времени
- Данные сохраняются корректно на всех этапах
- Система остается стабильной
- Управление подключениями работает корректно
