-- Создание таблицы пользователей
CREATE TABLE IF NOT EXISTS users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    username VARCHAR(100) UNIQUE NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Создание таблицы документов
CREATE TABLE IF NOT EXISTS documents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title VARCHAR(500) NOT NULL DEFAULT 'Без названия',
    content TEXT NOT NULL DEFAULT '',
    owner_id UUID REFERENCES users(id) ON DELETE SET NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Таблица для совместного доступа
CREATE TABLE IF NOT EXISTS document_collaborators (
    document_id UUID REFERENCES documents(id) ON DELETE CASCADE,
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    permission_level VARCHAR(20) CHECK (permission_level IN ('view', 'comment', 'edit')),
    invited_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (document_id, user_id)
);

-- Таблица для хранения истории изменений документов (для откатов и аудита)
CREATE TABLE IF NOT EXISTS document_versions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    document_id UUID REFERENCES documents(id) ON DELETE CASCADE,
    content TEXT NOT NULL,
    version_number INTEGER NOT NULL,
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Таблица сессий редактирования
CREATE TABLE IF NOT EXISTS editing_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    document_id UUID REFERENCES documents(id) ON DELETE CASCADE,
    user_id UUID REFERENCES users(id),
    started_at TIMESTAMPTZ DEFAULT NOW(),
    ended_at TIMESTAMPTZ,
    last_activity TIMESTAMPTZ DEFAULT NOW()
);

-- Индексы для производительности
CREATE INDEX IF NOT EXISTS idx_document_versions_doc_id ON document_versions(document_id);
CREATE INDEX IF NOT EXISTS idx_document_versions_created_at ON document_versions(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_editing_sessions_doc_user ON editing_sessions(document_id, user_id);
CREATE INDEX IF NOT EXISTS idx_editing_sessions_activity ON editing_sessions(last_activity);
CREATE INDEX IF NOT EXISTS idx_documents_owner ON documents(owner_id);
CREATE INDEX IF NOT EXISTS idx_documents_updated ON documents(updated_at DESC);
CREATE INDEX IF NOT EXISTS idx_collaborators_user ON document_collaborators(user_id);

INSERT INTO users (id, email, username) VALUES 
    ('11111111-1111-1111-1111-111111111111', 'test1@example.com', 'Boris'),
    ('22222222-2222-2222-2222-222222222222', 'test2@example.com', 'Nikita'),
    ('33333333-3333-3333-3333-333333333333', 'test3@example.com', 'Ivan'),
    ('44444444-4444-4444-4444-444444444444', 'test4@example.com', 'Polina'),
    ('55555555-5555-5555-5555-555555555555', 'test5@example.com', 'testuser')
ON CONFLICT (email) DO NOTHING;

INSERT INTO documents (id, title, content, owner_id) VALUES 
    ('11111111-1111-1111-1111-111111111100', 'Дифференциальная геометрия', 'Индикатриса кривизны', '11111111-1111-1111-1111-111111111111'),
    ('11111111-1111-1111-1111-111111111101', 'Линейная алгебра', 'Жорданова форма', '11111111-1111-1111-1111-111111111111'),
    ('11111111-1111-1111-1111-111111111102', 'Математический анализ', 'Ряды Фурье', '11111111-1111-1111-1111-111111111111'),
    ('11111111-1111-1111-1111-111111111103', 'Теория вероятностей', 'Закон больших чисел', '11111111-1111-1111-1111-111111111111'),
    ('11111111-1111-1111-1111-111111111104', 'Дифференциальные уравнения', 'Метод вариации постоянных', '11111111-1111-1111-1111-111111111111'),
    ('11111111-1111-1111-1111-111111111105', 'Функциональный анализ', 'Теорема Хана–Банаха', '11111111-1111-1111-1111-111111111111'),
    ('11111111-1111-1111-1111-111111111106', 'Топология', 'Непрерывные отображения', '11111111-1111-1111-1111-111111111111'),
    ('11111111-1111-1111-1111-111111111107', 'Теория графов', 'Эйлеровы пути', '11111111-1111-1111-1111-111111111111'),
    ('11111111-1111-1111-1111-111111111108', 'Комбинаторика', 'Принцип включения-исключения', '11111111-1111-1111-1111-111111111111'),
    ('11111111-1111-1111-1111-111111111109', 'Численные методы', 'Метод Ньютона', '11111111-1111-1111-1111-111111111111'),
    ('11111111-1111-1111-1111-11111111110a', 'Дискретная математика', 'Булевы функции', '11111111-1111-1111-1111-111111111111'),
    ('11111111-1111-1111-1111-11111111110b', 'Теория чисел', 'Малая теорема Ферма', '11111111-1111-1111-1111-111111111111'),
    ('11111111-1111-1111-1111-11111111110c', 'Алгебра', 'Группы Ли', '11111111-1111-1111-1111-111111111111'),
    ('11111111-1111-1111-1111-11111111110d', 'Геометрия', 'Теорема Паппа', '11111111-1111-1111-1111-111111111111'),
    ('11111111-1111-1111-1111-11111111110e', 'Логика', 'Исчисление высказываний', '11111111-1111-1111-1111-111111111111'),
    ('22222222-2222-2222-2222-222222222200', 'Алгоритмы и структуры данных', 'Двоичные деревья поиска', '22222222-2222-2222-2222-222222222222'),
    ('22222222-2222-2222-2222-222222222201', 'Операционные системы', 'Планирование процессов', '22222222-2222-2222-2222-222222222222'),
    ('22222222-2222-2222-2222-222222222202', 'Компьютерные сети', 'Маршрутизация OSPF', '22222222-2222-2222-2222-222222222222'),
    ('22222222-2222-2222-2222-222222222203', 'Базы данных', 'Нормальные формы', '22222222-2222-2222-2222-222222222222'),
    ('22222222-2222-2222-2222-222222222204', 'Распределённые системы', 'Консенсус Raft', '22222222-2222-2222-2222-222222222222'),
    ('22222222-2222-2222-2222-222222222205', 'Параллельные вычисления', 'Парадигма MapReduce', '22222222-2222-2222-2222-222222222222'),
    ('22222222-2222-2222-2222-222222222206', 'Компиляторы', 'Построение AST', '22222222-2222-2222-2222-222222222222'),
    ('22222222-2222-2222-2222-222222222207', 'Машинное обучение', 'Градиентный спуск', '22222222-2222-2222-2222-222222222222'),
    ('22222222-2222-2222-2222-222222222208', 'Информационная безопасность', 'Модель угроз STRIDE', '22222222-2222-2222-2222-222222222222'),
    ('22222222-2222-2222-2222-222222222209', 'Криптография', 'Протокол Диффи—Хеллмана', '22222222-2222-2222-2222-222222222222'),
    ('22222222-2222-2222-2222-22222222220a', 'Тестирование ПО', 'Эквивалентное разбиение', '22222222-2222-2222-2222-222222222222'),
    ('22222222-2222-2222-2222-22222222220b', 'Инженерия требований', 'User Stories', '22222222-2222-2222-2222-222222222222'),
    ('22222222-2222-2222-2222-22222222220c', 'DevOps', 'CI/CD пайплайны', '22222222-2222-2222-2222-222222222222'),
    ('22222222-2222-2222-2222-22222222220d', 'Контейнеризация', 'Docker Compose', '22222222-2222-2222-2222-222222222222'),
    ('22222222-2222-2222-2222-22222222220e', 'Мониторинг', 'Метрики Prometheus', '22222222-2222-2222-2222-222222222222'),
    ('33333333-3333-3333-3333-333333333300', 'Физика', 'Уравнения Максвелла', '33333333-3333-3333-3333-333333333333'),
    ('33333333-3333-3333-3333-333333333301', 'Квантовая механика', 'Оператор Гамильтона', '33333333-3333-3333-3333-333333333333'),
    ('33333333-3333-3333-3333-333333333302', 'Термодинамика', 'Свободная энергия', '33333333-3333-3333-3333-333333333333'),
    ('33333333-3333-3333-3333-333333333303', 'Оптика', 'Интерференция', '33333333-3333-3333-3333-333333333333'),
    ('33333333-3333-3333-3333-333333333304', 'Механика', 'Лагранжиан системы', '33333333-3333-3333-3333-333333333333'),
    ('33333333-3333-3333-3333-333333333305', 'Астрономия', 'Диаграмма Герцшпрунга—Рассела', '33333333-3333-3333-3333-333333333333'),
    ('33333333-3333-3333-3333-333333333306', 'Электродинамика', 'Потенциалы Лиенара—Вихерта', '33333333-3333-3333-3333-333333333333'),
    ('33333333-3333-3333-3333-333333333307', 'Ядерная физика', 'Распады и сечения', '33333333-3333-3333-3333-333333333333'),
    ('33333333-3333-3333-3333-333333333308', 'Статфизика', 'Распределение Больцмана', '33333333-3333-3333-3333-333333333333'),
    ('33333333-3333-3333-3333-333333333309', 'Сигналы и системы', 'Преобразование Лапласа', '33333333-3333-3333-3333-333333333333'),
    ('33333333-3333-3333-3333-33333333330a', 'Математическая физика', 'Функции Грина', '33333333-3333-3333-3333-333333333333'),
    ('33333333-3333-3333-3333-33333333330b', 'Электроника', 'RC-фильтры', '33333333-3333-3333-3333-333333333333'),
    ('33333333-3333-3333-3333-33333333330c', 'Радиофизика', 'Модуляция', '33333333-3333-3333-3333-333333333333'),
    ('33333333-3333-3333-3333-33333333330d', 'Нелинейная динамика', 'Аттрактор Лоренца', '33333333-3333-3333-3333-333333333333'),
    ('33333333-3333-3333-3333-33333333330e', 'Теория поля', 'Калибровочная инвариантность', '33333333-3333-3333-3333-333333333333'),
    ('44444444-4444-4444-4444-444444444400', 'Экономика', 'Эластичность спроса', '44444444-4444-4444-4444-444444444444'),
    ('44444444-4444-4444-4444-444444444401', 'Микроэкономика', 'Равновесие Нэша', '44444444-4444-4444-4444-444444444444'),
    ('44444444-4444-4444-4444-444444444402', 'Макроэкономика', 'Модель IS–LM', '44444444-4444-4444-4444-444444444444'),
    ('44444444-4444-4444-4444-444444444403', 'Финансы', 'Дисконтирование потоков', '44444444-4444-4444-4444-444444444444'),
    ('44444444-4444-4444-4444-444444444404', 'Статистика', 'Доверительные интервалы', '44444444-4444-4444-4444-444444444444'),
    ('44444444-4444-4444-4444-444444444405', 'Эконометрика', 'МНК-оценка', '44444444-4444-4444-4444-444444444444'),
    ('44444444-4444-4444-4444-444444444406', 'Менеджмент', 'Матрица SWOT', '44444444-4444-4444-4444-444444444444'),
    ('44444444-4444-4444-4444-444444444407', 'Маркетинг', 'Воронка продаж', '44444444-4444-4444-4444-444444444444'),
    ('44444444-4444-4444-4444-444444444408', 'Проектный менеджмент', 'Диаграмма Ганта', '44444444-4444-4444-4444-444444444444'),
    ('44444444-4444-4444-4444-444444444409', 'Управление рисками', 'Матрица рисков', '44444444-4444-4444-4444-444444444444'),
    ('44444444-4444-4444-4444-44444444440a', 'Бизнес-аналитика', 'KPI и метрики', '44444444-4444-4444-4444-444444444444'),
    ('44444444-4444-4444-4444-44444444440b', 'Бухгалтерский учёт', 'Двойная запись', '44444444-4444-4444-4444-444444444444'),
    ('44444444-4444-4444-4444-44444444440c', 'Право', 'Договорные обязательства', '44444444-4444-4444-4444-444444444444'),
    ('44444444-4444-4444-4444-44444444440d', 'Социология', 'Метод опроса', '44444444-4444-4444-4444-444444444444'),
    ('44444444-4444-4444-4444-44444444440e', 'Психология', 'Когнитивные искажения', '44444444-4444-4444-4444-444444444444')
ON CONFLICT (id) DO NOTHING;